<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
<style>
.day{
  height:30px;
  /*border-style: ridge;
  border-width: 1px;*/
  font-weight:bold;
  font-size: 0.6em;

}

.time{
  height:45px;
  width:45px;
  border-style: ridge;
  border-width: 1px;

}
@media screen and (max-height:400px){
#bigAdd{
  position: fixed;

  margin-top: -270px;
  margin-left: 290px;
}
}

@media screen and (min-height:400px){
#bigAdd{
  position: fixed;

  margin-top: -120px;
  margin-left: 290px;
}
}


.ptime{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.7em;


}
</style>
</head>

<body class="wrap">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">


  <div class="container" style="margin-top:10px;">
    <div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  </div>
  <div class="col">
<p>M</p>
</div>
  <div class="col">
<p>T</p>
</div>
  <div class="col">
<p>W</p>
</div>
  <div class="col">
<p>T</p>
</div>
  <div class="col">
<p>F</p>
</div>
  <div class="col">
<p>S</p>
</div>
  <div class="col">
<p>S</p>
</div>
</div>



<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  </div>
<div class="col day" id="d0">
<p id="0"></p>
</div>
<div class="col day" id="d1">
<p id="1"></p>
</div>
<div class="col day" id="d2">
<p id="2"></p>
</div>
<div class="col day" id="d3">
<p id="3"></p>
</div>
<div class="col day" id="d4">
<p id="4"></p>
</div>
<div class="col day" id="d5">
<p id="5"></p>
</div>
<div class="col day" id="d6">
<p id="6"></p>
</div>
</div>
<br>
<div class="row">
  <div class="col" style="width:5px;font-size: 0.6em;">
  <p>8AM</p>
  </div>
  <div class="col time" id="d10">
  <p class="ptime" id="10"></p>
  </div>
  <div class="col time" id="d11">
  <p class="ptime" id="11"></p>
  </div>
  <div class="col time" id="d12">
  <p class="ptime" id="12"></p>
  </div>
  <div class="col time" id="d13">
  <p class="ptime" id="13"></p>
  </div>
  <div class="col time" id="d14">
  <p class="ptime" id="14"></p>
  </div>
  <div class="col time" id="d15">
  <p class="ptime" id="15"></p>
  </div>
  <div class="col time" id="d16">
  <p class="ptime" id="16"></p>
  </div>
</div>

<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
<p>9</p>
  </div>
  <div class="col time" id="d20">
  <p class="ptime" id="20"></p>
  </div>
  <div class="col time" id="d21">
  <p class="ptime" id="21"></p>
  </div>
  <div class="col time" id="d22">
  <p class="ptime" id="22"></p>
  </div>
  <div class="col time" id="d23">
  <p class="ptime" id="23"></p>
  </div>
  <div class="col time" id="d24">
  <p class="ptime" id="24"></p>
  </div>
  <div class="col time" id="d25">
  <p class="ptime" id="25"></p>
  </div>
  <div class="col time" id="d26">
  <p class="ptime" id="26"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>10</p>
  </div>
  <div class="col time" id="d30">
  <p class="ptime" id="30"></p>
  </div>
  <div class="col time" id="d31">
  <p class="ptime" id="31"></p>
  </div>
  <div class="col time" id="d32">
  <p class="ptime" id="32"></p>
  </div>
  <div class="col time" id="d33">
  <p class="ptime" id="33"></p>
  </div>
  <div class="col time" id="d34">
  <p class="ptime" id="34"></p>
  </div>
  <div class="col time" id="d35">
  <p class="ptime" id="35"></p>
  </div>
  <div class="col time" id="d36">
  <p class="ptime" id="36"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
<p>11</p>
  </div>
  <div class="col time" id="d40">
  <p class="ptime" id="40"></p>
  </div>
  <div class="col time" id="d41">
  <p class="ptime" id="41"></p>
  </div>
  <div class="col time" id="d42">
  <p class="ptime" id="42"></p>
  </div>
  <div class="col time" id="d43">
  <p class="ptime" id="43"></p>
  </div>
  <div class="col time" id="d44">
  <p class="ptime" id="44"></p>
  </div>
  <div class="col time" id="d45">
  <p class="ptime" id="45"></p>
  </div>
  <div class="col time" id="d46">
  <p class="ptime" id="46"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>12PM</p>
  </div>
  <div class="col time" id="d50">
  <p class="ptime" id="50"></p>
  </div>
  <div class="col time" id="d51">
  <p class="text-left ptime" id="51"></p>
  </div>
  <div class="col time" id="d52">
  <p class="ptime" id="52"></p>
  </div>
  <div class="col time" id="d53">
  <p class="ptime" id="53"></p>
  </div>
  <div class="col time" id="d54">
  <p class="ptime" id="54"></p>
  </div>
  <div class="col time" id="d55">
  <p class="ptime" id="55"></p>
  </div>
  <div class="col time" id="d56">
  <p class="ptime" id="56"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
<p>1</p>
  </div>
  <div class="col time" id="d60">
  <p class="ptime" id="60"></p>
  </div>
  <div class="col time" id="d61">
  <p class="text-left ptime" id="61"></p>
  </div>
  <div class="col time" id="d62">
  <p class="ptime" id="62"></p>
  </div>
  <div class="col time" id="d63">
  <p class="ptime" id="63"></p>
  </div>
  <div class="col time" id="d64">
  <p class="ptime" id="64"></p>
  </div>
  <div class="col time" id="d65">
  <p class="ptime" id="65"></p>
  </div>
  <div class="col time" id="d66">
  <p class="ptime" id="66"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
<p>2</p>
  </div>
  <div class="col time" id="d70">
  <p class="ptime" id="70"></p>
  </div>
  <div class="col time" id="d71">
  <p class="ptime" id="71"></p>
  </div>
  <div class="col time" id="d72">
  <p class="ptime" id="72"></p>
  </div>
  <div class="col time" id="d73">
  <p class="ptime" id="73"></p>
  </div>
  <div class="col time" id="d74">
  <p class="ptime" id="74"></p>
  </div>
  <div class="col time" id="d75">
  <p class="ptime" id="75"></p>
  </div>
  <div class="col time" id="d76">
  <p class="ptime" id="76"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>3</p>
  </div>
  <div class="col time" id="d80">
  <p class="ptime" id="80"></p>
  </div>
  <div class="col time" id="d81">
  <p class="ptime" id="81"></p>
  </div>
  <div class="col time" id="d82">
  <p class="ptime" id="82"></p>
  </div>
  <div class="col time" id="d83">
  <p class="ptime" id="83"></p>
  </div>
  <div class="col time" id="d84">
  <p class="ptime" id="84"></p>
  </div>
  <div class="col time" id="d85">
  <p class="ptime" id="85"></p>
  </div>
  <div class="col time" id="d86">
  <p class="ptime" id="86"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>4</p>
  </div>
  <div class="col time" id="d90">
  <p class="ptime" id="90"></p>
  </div>
  <div class="col time" id="d91">
  <p class="ptime" id="91"></p>
  </div>
  <div class="col time" id="d92">
  <p class="ptime" id="92"></p>
  </div>
  <div class="col time" id="d93">
  <p class="ptime" id="93"></p>
  </div>
  <div class="col time" id="d94">
  <p class="ptime" id="94"></p>
  </div>
  <div class="col time" id="d95">
  <p class="ptime" id="95"></p>
  </div>
  <div class="col time" id="d96">
  <p class="ptime" id="96"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>5</p>
  </div>
  <div class="col time" id="d100">
  <p class="ptime" id="100"></p>
  </div>
  <div class="col time" id="d101">
  <p class="ptime" id="101"></p>
  </div>
  <div class="col time" id="d102">
  <p class="ptime" id="102"></p>
  </div>
  <div class="col time" id="d103">
  <p class="ptime" id="103"></p>
  </div>
  <div class="col time" id="d104">
  <p class="ptime" id="104"></p>
  </div>
  <div class="col time" id="d105">
  <p class="ptime" id="105"></p>
  </div>
  <div class="col time" id="d106">
  <p class="ptime" id="106"></p>
  </div>
</div>
<div class="row">
  <div class="col" id="" style="width:5px;font-size: 0.6em;">
  <p>6</p>
  </div>
  <div class="col time" id="d110">
  <p class="ptime" id="110"></p>
  </div>
  <div class="col time" id="d111">
  <p class="ptime" id="111"></p>
  </div>
  <div class="col time" id="d112">
  <p class="ptime" id="112"></p>
  </div>
  <div class="col time" id="d113">
  <p class="ptime" id="113"></p>
  </div>
  <div class="col time" id="d114">
  <p class="ptime" id="114"></p>
  </div>
  <div class="col time" id="d115">
  <p class="ptime" id="115"></p>
  </div>
  <div class="col time" id="d116">
  <p class="ptime" id="116"></p>
  </div>
</div>



<div id="bigAdd">
<img src="../image/add.png" id="addTimeButton" height="50px" width="50px" data-toggle="modal" data-target="#exampleModal2">
</div>
<br>
<br>

  </div>

  <div class = "modal fade" id = "exampleModal" tabindex = "-1" role = "dialog" aria-labelledby ="exampleModalLabel" aria-hidden = "true">
             <div class="modal-dialog modal-dialog-centered" role="document">
                <div class = "modal-content">
                   <div class = "modal-header" >
                      <h5 class = "modal-title text-center col2" id = "exampleModalLabel"><br>
                          </h5>

                    <hr>
                   </div>

                   <div class = "modal-body">
                   </div>

        </div>
        </div>
        </div>

        <div class = "modal fade" id = "exampleModal2" tabindex = "-1" role = "dialog" aria-labelledby ="exampleModalLabel" aria-hidden = "true">
                   <div class="modal-dialog modal-dialog-centered" role="document">
                      <div class = "modal-content">
                        <div class = "modal-header" >
                           <h6 class = "modal-title text-center col2" id = "wcreate">
                             Which are you creating?
                           </h6>


                        </div>

                         <div class = "modal-body">
                           <div class="row">
                             <div class="col-6 text-center" style="border-right:1px solid black" id="goToAddTime">
                               Event
                               </div>
                               <div class="col-6 text-center" id="goToAddMemo">
                               Reminder
                             </div>
                             </div>

                         </div>

              </div>
              </div>
              </div>



  <script src = "https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity = "sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin = "anonymous"></script>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">

//document.getElementById("tusername").innerHTML = localStorage.getItem("username") + "'s timetable"
function blockPressed(id){
  var clearS = document.getElementsByClassName('smallAddTime')
if(clearS.length != 0){
  clearS[0].style.backgroundColor = "white"
  clearS[0].style.borderWidth = "1px"
  clearS[0].style.borderStyle = 'ridge';
  clearS[0].innerHTML = ""
  clearS[0].style.height = "45px"
  var afuncStr = "blockPressed('" + clearS[0].id + "')" //must be prev button
  console.log(afuncStr)
  clearS[0].setAttribute("onclick",afuncStr)
  clearS[0].setAttribute('class','col time')
}




  document.getElementById(id).style.backgroundColor = 'rgb(233, 207, 207)'
  document.getElementById(id).style.borderWidth = '1px'
  document.getElementById(id).style.borderStyle = 'solid'
  document.getElementById(id).innerHTML = "<img src='../image/smalladd.png' width='16px' height='13px' style='margin:14px;'>"
  var funcStr = 'goToAddTime("' + id +'")'
  document.getElementById(id).setAttribute('class','smallAddTime')
  document.getElementById(id).setAttribute('onclick',funcStr)

  // var newId = '#'+ id
  // $(newId).prop("onclick",null).off("click")
}
function goToAddTime(id){
  var tid = parseInt(id.slice(-1))


  var curY = new Date().getFullYear()
  var curr = new Date()
  var curr2 = new Date()
  //format getDay
  if(curr.getDay() == 0){
    var cday = 6
  }else{
    var cday = curr.getDay() -1
  }
  var minusM = cday -tid
  console.log(minusM)
  var nday = curr.getDate() - minusM
  let tday = new Date(curr.setDate(nday)).getDate()
  let mday = new Date(curr2.setDate(nday)).getMonth() + 1
  if(mday < 10){
    mday = "0" + String(mday)
  }
  if(tday < 10){
    tday = "0" + String(tday)
  }
  console.log(tday,cday,mday)
//   var dayList = []
//   var monthList = []
//   for(i=1;i<8;i++){
//   let first = curr.getDate() - curr.getDay() + i
//   let day = new Date(curr.setDate(first)).getDate()
//   let month = new Date(curr.setDate(first)).getMonth()
//   dayList.push(day)
//   monthList.push(month)
// }
// console.log(monthList,dayList)
//   var tday = dayList[tid]
  wdString = curY + "-" + mday + "-" + tday
  console.log(wdString)


  api.openFrame({
    name: 'Add Time page',
    url: 'addTime.html',
    // bounces:true,
    rect: { // 推荐使用Margin布局，用于适配屏幕的动态变化
        marginTop:0,
        marginBottom: 0, // main页面距离win顶部的高度
        w: 'auto' // main页面的宽度 自适应屏幕宽度
    },
    pageParam:({
      date:wdString,
      time:id.substring(1,id.length - 1)
    })
  })
}

    apiready = function() {

      var theIp = ''
      $(function (){
        var myAjax = {
          init: function(){
            $.ajax({
              url: "../wifi.txt",
              async:false,
              success:function(data){
                theIp = data
              }
            })
          }
        };
        myAjax.init()
      });

      //loadblock start here


      var curM = new Date().getMonth()
      var curY = new Date().getFullYear()
      var curr = new Date()
      var curr2 = new Date()

      var dayList = []
      for(i=1;i<8;i++){
      let first = curr.getDate() - curr.getDay() + i
      let day = new Date(curr.setDate(first)).getDate()

      dayList.push(day)
    }
      for(i=0;i<7;i++){
        document.getElementById(String(i)).innerHTML = dayList[i]
        var dday = "d" + String(i)
      }


      var allTime = document.getElementsByClassName('time')
      console.log(allTime)
      for(i=0;i<allTime.length;i++){
        var rId = allTime[i].id

        var funcStr = 'blockPressed("' + rId +'")'

        allTime[i].setAttribute('onclick',funcStr)
      }
      var curr = new Date()
      var curr2 = new Date()
      if(curr.getDay() == 0){
        var cday = 6
      }else{
        var cday = curr.getDay() -1
      }

      var dayList2 = []
      for(i=0;i<7;i++){
        let firstD = curr.getDate()  - cday + i
        console.log(firstD)
        let dday = new Date(curr.setDate(firstD)).getDate()
        let dmonth = new Date(curr2.setDate(firstD)).getMonth() + 1
        var curr = new Date()
        var curr2 = new Date()
        if (dday < 10){
          dday = "0" + String(dday)
        }
        if (dmonth < 10){
          dmonth = "0" + String(dmonth)
        }
        var nDay = String(curY) + String(dmonth) + String(dday)
        dayList2.push(nDay)
    }
    console.log(dayList2)

      api.ajax({
          url: theIp + 'loadWeekBlock',
          method: 'post',
          timeout:30,
          data: {
              values: {
                  username: localStorage.getItem("username"),
                  tdate:dayList2
              },
          },
        },
         function(ret, err){
           if(ret){

             for(i=0;i<ret.length;i++){
               var tstart = ret[i].start.slice(8)// get 0900
               var tend = ret[i].end.slice(8)
                if(parseInt(tend)<1801 && parseInt(tstart)>0759){
                    var startp = parseInt(tstart.slice(2)) / 60 *100
                    var startpr = 100 - startp
                    var endp = parseInt(tend.slice(2)) / 60 *100
                    var endpr = 100 - endp
                    var newStart = (parseInt(tstart.substring(0,2)) - 8) * 10
                    var newEnd = (parseInt(tend.substring(0,2)) - 8) * 10
                    var tCount = (newEnd - newStart) /10
                    var pposition = String(startp/10 * 3.8) +"px"

                    console.log(newStart)

                    for(i2=0;i2<tCount;i2++){
                      var tBlock = "d" + String(newStart  + (i2+1) *10 + parseInt(ret[i].day))
                      if(i2 == 0){
                        document.getElementById(tBlock).style.background = "linear-gradient(to top,"+ ret[i].color + " "+ String(startpr) +"%,transparent "+ String(startpr) +"%,transparent "+String(startp)+"%,#ffffff "+String(startp)+"%)"
                        var tptag = String(newStart  + (i2+1) *10 + parseInt(ret[i].day))
                        document.getElementById(tptag).innerHTML = ret[i].title
                        document.getElementById(tptag).style.marginLeft = "-14px"
                        document.getElementById(tBlock).style.width = "45px"
                        document.getElementById(tptag).style.width = "40px"
                        document.getElementById(tptag).style.marginTop = pposition

                      }else if(i2 == tCount-1){
                        document.getElementById(tBlock).style.background = "linear-gradient(to bottom,"+ ret[i].color + " "+ String(endp) +"%,transparent "+ String(endp) +"%,transparent "+String(endpr)+"%,#ffffff "+String(endpr)+"%)"
                      }else{

                      document.getElementById(tBlock).style.backgroundColor = ret[i].color

                    }
                    document.getElementById(tBlock).style.borderBottom = "0px"
                    document.getElementById(tBlock).style.borderTop = "0px"
                    document.getElementById(tBlock).setAttribute('onclick',"")

                  }

             }

             }
           }
         })

      var allClasses = []
      api.ajax({
          url: theIp + 'getAllClassTeach',
          method: 'post',
          timeout:30,
          data: {
              values: {
                  username: localStorage.getItem("username")
              },
          },
        },
         function(ret2, err){

           if(ret2.length > 0){

             for(i2=0;i2<ret2.length;i2++){
               allClasses.push(ret2[i2].classCode)
               if(i2 == ret2.length - 1){
                 console.log(allClasses)
                 api.sendEvent({
                       name: 'finishClassLoad',
                       extra: {
                          allClasses:allClasses
                       }
                   });
               }
             }

           }
         })



         api.addEventListener({
             name: 'finishClassLoad'
         }, function(ret2, err) {
            console.log("finish")
           for(i=0;i<allClasses.length;i++){
             api.ajax({
                 url: theIp + 'loadWeekClassBlock',
                 method: 'post',
                 timeout:30,
                 data: {
                     values: {
                         classCode: allClasses[i],
                         tdate:dayList2
                     },
                 },
               },
                function(ret, err){
                  if(ret){

                    for(i=0;i<ret.length;i++){
                      var tstart = ret[i].start.slice(8)// get 0900
                      var tend = ret[i].end.slice(8)
                       if(parseInt(tend)<1801 && parseInt(tstart)>0759){
                           var startp = parseInt(tstart.slice(2)) / 60 *100
                           var startpr = 100 - startp
                           var endp = parseInt(tend.slice(2)) / 60 *100
                           var endpr = 100 - endp
                           var newStart = (parseInt(tstart.substring(0,2)) - 8) * 10
                           var newEnd = (parseInt(tend.substring(0,2)) - 8) * 10
                           var tCount = (newEnd - newStart) /10
                           var pposition = String(startp/10 * 3.8) +"px"

                           console.log(newStart)

                           for(i2=0;i2<tCount;i2++){
                             var tBlock = "d" + String(newStart  + (i2+1) *10 + parseInt(ret[i].day))
                             if(i2 == 0){
                               document.getElementById(tBlock).style.background = "linear-gradient(to top,"+ ret[i].color + " "+ String(startpr) +"%,transparent "+ String(startpr) +"%,transparent "+String(startp)+"%,#ffffff "+String(startp)+"%)"
                               var tptag = String(newStart  + (i2+1) *10 + parseInt(ret[i].day))
                               document.getElementById(tptag).innerHTML = ret[i].title
                               document.getElementById(tptag).style.marginLeft = "-14px"
                               document.getElementById(tBlock).style.width = "45px"
                               document.getElementById(tptag).style.width = "40px"
                               document.getElementById(tptag).style.marginTop = pposition

                             }else if(i2 == tCount-1){
                               document.getElementById(tBlock).style.background = "linear-gradient(to bottom,"+ ret[i].color + " "+ String(endp) +"%,transparent "+ String(endp) +"%,transparent "+String(endpr)+"%,#ffffff "+String(endpr)+"%)"
                             }else{

                             document.getElementById(tBlock).style.backgroundColor = ret[i].color

                           }
                           document.getElementById(tBlock).style.borderBottom = "0px"
                           document.getElementById(tBlock).style.borderTop = "0px"
                           document.getElementById(tBlock).setAttribute('onclick',"")

                         }
                    }

                    }
                  }
                })
           }
      })






      //insert load timeblock code here

      $("#goToAddTime").click(function(){
        $('#exampleModal2').modal('hide')
        api.openFrame({
          name: 'Add Time page',
          url: 'addTime.html',
          // bounces:true,
          rect: { // 推荐使用Margin布局，用于适配屏幕的动态变化
              marginTop:0,
              marginBottom: 0, // main页面距离win顶部的高度
              w: 'auto' // main页面的宽度 自适应屏幕宽度
          }
          //pageParam:
        })
      })

      $("#goToAddMemo").click(function(){
        $('#exampleModal2').modal('hide')
        api.openFrame({
          name: 'Add Memo page',
          url: 'addMemo.html',
          // bounces:true,
          rect: { // 推荐使用Margin布局，用于适配屏幕的动态变化
              marginTop:0,
              marginBottom: 0, // main页面距离win顶部的高度
              w: 'auto' // main页面的宽度 自适应屏幕宽度
          }
          //pageParam:
        })
      })


    };

</script>

</html>
