<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>Profile Page</title>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
<style>
table, th, td{
  border: 1px solid black;

}
th, td{
  height:50px;
  padding: 5px;
}

.timeCell{
  width:60px;
}



</style>
</head>

<body class="wrap">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">


  <div class="container" >

    <section class="flex-1">
      <br>
      <div class="row">
      <div class="col-md-12">
      <h4 id="tcourse" style="text-align:center;"></h4>
       <button type = "button" class = "btn btn-info" data-toggle = "modal" data-target = "#exampleModal">Add Module</button>
      </div>
      </div>
      <br>

      <div class="row">
      <div class="col-md-12">
      <table style="width">
        <tr>
        <th></th>
      <th style="text-align:center;">Mon</th>
      <th style="text-align:center;">Tue</th>
      <th style="text-align:center;">Wed</th>
      <th style="text-align:center;">Thu</th>
      <th style="text-align:center;">Fri</th>
        </tr>
<tr>
<th>8:00</th>
<th class="timeCell" id="11"></th>
<th class="timeCell" id="12"></th>
<th class="timeCell" id="13"></th>
<th class="timeCell" id="14"></th>
<th class="timeCell" id="15"></th>
</tr>
<tr>
<th>9:00</th>
<th class="timeCell" id="21"></th>
<th class="timeCell" id="22" ></th>
<th class="timeCell" id="23"></th>
<th class="timeCell" id="24"></th>
<th class="timeCell" id="25"></th>
</tr>
<tr>
<th>10:00</th>
<th class="timeCell" id="31"></th>
<th class="timeCell" id="32"></th>
<th class="timeCell" id="33"></th>
<th class="timeCell" id="34"></th>
<th class="timeCell" id="35"></th>
</tr>
<tr>
<th>11:00</th>
<th class="timeCell" id="41"></th>
<th class="timeCell" id="42"></th>
<th class="timeCell" id="43"></th>
<th class="timeCell" id="44"></th>
<th class="timeCell" id="45"></th>
</tr>
<tr>
<th>12:00</th>
<th class="timeCell" id="51"></th>
<th class="timeCell" id="52"></th>
<th class="timeCell" id="53"></th>
<th class="timeCell" id="54"></th>
<th class="timeCell" id="55"></th>
</tr>
<tr>
<th>13:00</th>
<th class="timeCell" id="61"></th>
<th class="timeCell" id="62"></th>
<th class="timeCell" id="63"></th>
<th class="timeCell" id="64"></th>
<th class="timeCell" id="65"></th>
</tr>
<tr>
<th>14:00</th>
<th class="timeCell" id="71"></th>
<th class="timeCell" id="72"></th>
<th class="timeCell" id="73"></th>
<th class="timeCell" id="74"></th>
<th class="timeCell" id="75"></th>
</tr>
<tr>
<th>15:00</th>
<th class="timeCell" id="81"></th>
<th class="timeCell" id="82"></th>
<th class="timeCell" id="83"></th>
<th class="timeCell" id="84"></th>
<th class="timeCell" id="85"></th>
</tr>
<tr>
<th>16:00</th>
<th class="timeCell" id="91"></th>
<th class="timeCell" id="92"></th>
<th class="timeCell" id="93"></th>
<th class="timeCell" id="94"></th>
<th class="timeCell" id="95"></th>
</tr>
<tr>
<th>17:00</th>
<th class="timeCell" id="101"></th>
<th class="timeCell" id="102"></th>
<th class="timeCell" id="103"></th>
<th class="timeCell" id="104"></th>
<th class="timeCell" id="105"></th>
</tr>
<tr>
<th>18:00</th>
<th class="timeCell" id="111"></th>
<th class="timeCell" id="112"></th>
<th class="timeCell" id="113"></th>
<th class="timeCell" id="114"></th>
<th class="timeCell" id="115"></th>
</tr>
      </table>
      </div>
      </div>

    </section>

</div>
<div class = "modal fade" id = "exampleModal" tabindex = "-1" role = "dialog" aria-labelledby ="exampleModalLabel" aria-hidden = "true">
           <div class="modal-dialog modal-dialog-centered" role="document">
              <div class = "modal-content">
                 <div class = "modal-header">
                    <h5 class = "modal-title" id = "exampleModalLabel">Add Item</h5>
                    <button type = "button" class = "close" data-dismiss = "modal" aria-label = "Close">
                       <span aria-hidden = "true">×</span>
                    </button>
                 </div>

                 <div class = "modal-body">
                   <form method="post" id="addBlock" class="form-group col-lg-12">
                        <div class="form-group col-md-12" id="regbox">
                          <div class="form-row">
                            <div class="form-group col-md-12">
                                Module:<br>
                            <input type="text" name="module" id="module" class="form-control" required>
                            </div>
                          </div>
                          <div class="form-row">
                            <div class="form-group col-md-12">
                                <label>Day:</label>
                                <select class="form-control" name="pref" id="day">
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                      </select>
                            </div>
                          </div>
                          <div class="form-row">
                            <div class="form-group col-md-12">
                                <label>Start Time:</label>
                                <select class="form-control" name="pref" id="start">
                                        <option value="10">8:00 am</option>
                                        <option value="20">9:00 am</option>
                                        <option value="30">10:00 am</option>
                                        <option value="40">11:00 am</option>
                                        <option value="50">12:00 am</option>
                                        <option value="60">1:00 pm</option>
                                        <option value="70">2:00 pm</option>
                                        <option value="80">3:00 pm</option>
                                        <option value="90">4:00 pm</option>
                                        <option value="100">5:00 pm</option>

                                      </select>
                            </div>
                          </div>
                          <div class="form-row">
                            <div class="form-group col-md-12">
                                <label>End Time:</label>
                                <select class="form-control" name="pref" id="end">

                                  <option value="20">9:00 am</option>
                                  <option value="30">10:00 am</option>
                                  <option value="40">11:00 am</option>
                                  <option value="50">12:00 am</option>
                                  <option value="60">1:00 pm</option>
                                  <option value="70">2:00 pm</option>
                                  <option value="80">3:00 pm</option>
                                  <option value="90">4:00 pm</option>
                                  <option value="100">5:00 pm</option>
                                  <option value="110">6:00 pm</option>
                                      </select>
                            </div>
                          </div>

                          <div class="form-row">
                            <div class="form-group col-md-12">
                                <label>Color:</label>
                                <select class="form-control" name="pref" id="bColor">
                                        <option value="pink" style="background-color:pink;">Pink</option>
                                        <option value="yellow" style="background-color:green;">Yellow</option>
                                        <option value="orange" style="background-color:orange;">Orange</option>
                                        <option value="lightblue" style="background-color:orange;">Light Blue</option>
                                        <option value="lightgray" style="background-color:orange;">Light Gray</option>
                                      </select>
                            </div>
                          </div>

                      </div>
                  </form>
                 </div>

                 <div class = "modal-footer">

                    <button type = "button" class = "btn btn-success" id="saveBlock" data-dismiss = "modal">Save</button>
                 </div>

              </div>
           </div>
        </div>



        <div class = "modal fade" id = "exampleModal2" tabindex = "-1" role = "dialog" aria-labelledby ="exampleModalLabel" aria-hidden = "true">
                   <div class="modal-dialog modal-dialog-centered" role="document">
                      <div class = "modal-content">
                         <div class = "modal-header">
                            <h5 class = "modal-title" id = "blockName"></h5>
                            <button type = "button" class = "close" data-dismiss = "modal" aria-label = "Close">
                               <span aria-hidden = "true">×</span>
                            </button>
                         </div>

                         <div class = "modal-body">
                           <form id="editBlock" class="form-group col-lg-12">
                                <div class="form-group col-md-12" id="regbox">
                                  <div class="form-row">
                                    <div class="form-group col-md-12">
                                        Module:<br>
                                    <input type="text" name="emodule" id="emodule" class="form-control" required>
                                    </div>
                                  </div>
                                  <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label>Day:</label>
                                        <select class="form-control" name="pref" id="eday">
                                                <option id="ed1" value="1">Monday</option>
                                                <option id="ed2" value="2">Tuesday</option>
                                                <option id="ed3" value="3">Wednesday</option>
                                                <option id="ed4" value="4">Thursday</option>
                                                <option id="ed5" value="5">Friday</option>
                                              </select>
                                    </div>
                                  </div>
                                  <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label>Start Time:</label>
                                        <select class="form-control" name="pref" id="estart">
                                                <option id="es10" value="10">8:00 am</option>
                                                <option id="es20" value="20">9:00 am</option>
                                                <option id="es30" value="30">10:00 am</option>
                                                <option id="es40" value="40">11:00 am</option>
                                                <option id="es50" value="50">12:00 am</option>
                                                <option id="es60" value="60">1:00 pm</option>
                                                <option id="es70" value="70">2:00 pm</option>
                                                <option id="es80" value="80">3:00 pm</option>
                                                <option id="es90" value="90">4:00 pm</option>
                                                <option id="es100" value="100">5:00 pm</option>

                                              </select>
                                    </div>
                                  </div>
                                  <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label>End Time:</label>
                                        <select class="form-control" name="pref" id="eend">

                                          <option id="ee20" value="20">9:00 am</option>
                                          <option id="ee30" value="30">10:00 am</option>
                                          <option id="ee40" value="40">11:00 am</option>
                                          <option id="ee50" value="50">12:00 am</option>
                                          <option id="ee60" value="60">1:00 pm</option>
                                          <option id="ee70" value="70">2:00 pm</option>
                                          <option id="ee80" value="80">3:00 pm</option>
                                          <option id="ee90" value="90">4:00 pm</option>
                                          <option id="ee100" value="100">5:00 pm</option>
                                          <option id="ee110" value="110">6:00 pm</option>
                                              </select>
                                    </div>
                                  </div>

                                  <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label>Color:</label>
                                        <select class="form-control" name="pref" id="ebColor">
                                                <option id="epink" value="pink" style="background-color:pink;">Pink</option>
                                                <option id="eyellow" value="yellow" style="background-color:green;">Yellow</option>
                                                <option id="eorange" value="orange" style="background-color:orange;">Orange</option>
                                                <option value="lightblue" style="background-color:orange;">Light Blue</option>
                                                <option value="lightgray" style="background-color:orange;">Light Gray</option>


                                              </select>
                                    </div>
                                  </div>

                              </div>
                          </form>
                         </div>

                         <div class = "modal-footer">
                           <button type = "button" class = "btn btn-secondary" id="editButton" data-dismiss = "modal">Edit</button>
                            <button type = "button" class = "btn btn-success" id="removeBlock" data-dismiss = "modal">Remove</button>
                         </div>

                      </div>
                   </div>
                </div>




  <script src = "https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity = "sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin = "anonymous"></script>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">

function blockPressed(mod,start,end,color){
  console.log(end)
  document.getElementById('blockName').innerHTML = mod
  document.getElementById('emodule').setAttribute('value',mod)
  document.getElementById('editButton').setAttribute('value',mod)
  var eday = "ed"+ start.charAt(1)
  document.getElementById(eday).setAttribute('selected','selected')
  var startint = Math.round(parseInt(start) / 10) * 10
  var estart = "es"+ String(startint)
  document.getElementById(estart).setAttribute('selected','selected')
  var endint = Math.round(parseInt(end) / 10) * 10
  var eend = "ee"+ String(endint)
  document.getElementById(eend).setAttribute('selected','selected')
  var ecolor = "e" +color
  document.getElementById(ecolor).setAttribute('selected','selected')
  document.getElementById('removeBlock').setAttribute('name',mod)
}


    apiready = function() {
      if(localStorage.getItem("isLoggedin") != "true"){
        api.openWin({
          name: "Login Page",
          url: '../index.html',
          bounces: true
        })
      }

      var theIp = ''
      $(function (){
        var myAjax = {
          init: function(){
            $.ajax({
              url: "../wifi.txt",
              async:false,
              success:function(data){
                theIp = data
              }
            })
          }
        };
        myAjax.init()
      });

      document.getElementById("tcourse").innerHTML = api.pageParam.course + " timetable"

      api.ajax({
          url: theIp + 'adloadBlock',
          method: 'post',
          timeout:30,
          data: {
              values: {
                course:api.pageParam.course
            },
          },
      },function(ret, err){
        for(i=0;i<ret.length;i++){

          document.getElementById(ret[i].start).rowSpan = ret[i].end.length + 1
          document.getElementById(ret[i].start).style.backgroundColor = ret[i].color
          for(i2=0;i2<ret[i].end.length;i2++){
            document.getElementById(ret[i].end[i2]).style.display = "none"
          }
          document.getElementById(ret[i].start).innerHTML = ret[i].module

          var funcStr = 'blockPressed("' + ret[i].module + '","' +ret[i].start+ '","' +ret[i].end[ret[i].end.length - 1] + '","' +ret[i].color +'")'
          console.log(funcStr)
          document.getElementById(ret[i].start).setAttribute('onclick',funcStr)
          document.getElementById(ret[i].start).setAttribute('data-toggle','modal')
          document.getElementById(ret[i].start).setAttribute('data-target','#exampleModal2')

        }
      })

      $("#removeBlock").click(function(){


        var tmodule = document.getElementById('blockName').innerHTML;

        api.ajax({
            url: theIp + 'adremoveBlock',
            method: 'post',
            timeout:30,
            data: {
                values: {
                  course:api.pageParam.course,
                  module:tmodule
              },
            },
        },function(ret, err){
          if(ret){
            console.log(ret)
            document.getElementById(ret.start).rowSpan = 1
            document.getElementById(ret.start).style.backgroundColor = 'white'
            for(i2=0;i2<ret.end.length;i2++){
              document.getElementById(ret.end[i2]).style.display = ""
            }
            document.getElementById(ret.start).innerHTML = ''

            api.alert({
              title:'Delete Success',
              msg:tmodule + ' has been removed'
            })
          }
        })

      })


      $("#editButton").click(function(){
        var start = $('#estart').find(":selected").val()
        var end = $('#eend').find(":selected").val()
        var day = $('#eday').find(":selected").val()
        var tcolor = $('#ebColor').find(":selected").val()
        var tmodule = $("#emodule").val();
        var endA = []

        if(parseInt(start) < parseInt(end)){
          var tstart = parseInt(start) + parseInt(day)
          var iteration = (parseInt(end) - parseInt(start)) / 10
          for(i=0;i<iteration;i++){
            endA.push(String(parseInt(start)+(i+1)*10 + parseInt(day)))
          }
          console.log(endA)

          api.ajax({
              url: theIp + 'adcheckBlock',
              method: 'post',
              timeout:30,
              data: {
                  values: {
                    course:api.pageParam.course,
                    module:tmodule,
                    start: String(tstart),
                    end: endA
                },
              },

          },function(ret, err){
          //remove current block
          if(ret.check == "clear"){
            var emodule2 = document.getElementById('editButton').value
            api.ajax({
                url: theIp + 'adremoveBlock',
                method: 'post',
                timeout:30,
                data: {
                    values: {
                      course:api.pageParam.course,
                      module:emodule2
                  },
                },

            },function(ret, err){
              if(ret){
                document.getElementById(ret.start).rowSpan = 1
                document.getElementById(ret.start).style.backgroundColor = 'white'
                for(i2=0;i2<ret.end.length;i2++){
                  document.getElementById(ret.end[i2]).style.display = ""
                }
                document.getElementById(ret.start).innerHTML = ''


              }
            })


          }
            console.log(ret.check)
              if (ret.check == "clear") {
                //displaying the block
                for(i=0;i<endA.length;i++){
                  document.getElementById(String(endA[i])).style.display = "none"
                }
                console.log(String(parseInt(start)+parseInt(day)))
                var tstart = String(parseInt(start)+parseInt(day))
                document.getElementById(tstart).rowSpan = endA.length + 1
                document.getElementById(tstart).style.backgroundColor = tcolor
                document.getElementById(tstart).innerHTML = tmodule
                var funcStr = 'blockPressed("' + tmodule + '","' +tstart+ '","' + endA[endA.length -1] + '","' + tcolor +'")'
                document.getElementById(tstart).setAttribute('onclick',funcStr)
                document.getElementById(tstart).setAttribute('data-toggle','modal')
                document.getElementById(tstart).setAttribute('data-target','#exampleModal2')

                //put block into database
                api.ajax({
                    url: theIp + 'adaddBlock',
                    method: 'post',
                    timeout:30,
                    data: {
                        values: {
                          course:api.pageParam.course,
                          module: tmodule,
                          start: String(tstart),
                          end: endA,
                          color: tcolor
                    },
                  },
                },function(ret, err){
                    if (ret) {
                      api.alert({
                        title:'Module Edited',
                        msg:'The module has been moved!'
                      })
                    } else {
                        //alert( JSON.stringify( err ) );
                    }
                });

              } else {
                  api.alert({
                    title:'Invalid Action',
                    msg:'Timetable block already exists!'
                  })
              }
          });
              }else{ // if start is before end
                api.alert({
                  title:'Invalid Action',
                  msg:'Start time cannot be after end time!'
                })

              }

            })




      $("#saveBlock").click(function(){
        var start = $('#start').find(":selected").val()
        var end = $('#end').find(":selected").val()
        var day = $('#day').find(":selected").val()
        var tcolor = $('#bColor').find(":selected").val()
        var tmodule = $("#module").val();
        var endA = []

        if(parseInt(start) < parseInt(end)){
          var tstart = parseInt(start) + parseInt(day)
          var iteration = (parseInt(end) - parseInt(start)) / 10
          for(i=0;i<iteration;i++){
            endA.push(String(parseInt(start)+(i+1)*10 + parseInt(day)))
          }
          console.log(endA)

          api.ajax({
              url: theIp + 'adcheckBlock',
              method: 'post',
              timeout:30,
              data: {
                  values: {
                    course:api.pageParam.course,
                    module:tmodule,
                    start: String(tstart),
                    end: endA
                },
              },
          },function(ret, err){
            console.log(ret.check,"ret check val")
              if (ret.check == "clear") {
                //displaying the block
                for(i=0;i<endA.length;i++){
                  document.getElementById(String(endA[i])).style.display = "none"
                }
                console.log(String(parseInt(start)+parseInt(day)))
                var tstart = String(parseInt(start)+parseInt(day))
                document.getElementById(tstart).rowSpan = endA.length + 1
                document.getElementById(tstart).style.backgroundColor = tcolor
                document.getElementById(tstart).innerHTML = tmodule
                var funcStr = 'blockPressed("' + tmodule + '","' + tstart + '","' + endA[endA.length - 1] + '","' +tcolor +'")'
                document.getElementById(tstart).setAttribute('onclick',funcStr)
                document.getElementById(tstart).setAttribute('data-toggle','modal')
                document.getElementById(tstart).setAttribute('data-target','#exampleModal2')

                //put block into database
                api.ajax({
                    url: theIp + 'adaddBlock',
                    method: 'post',
                    timeout:30,
                    data: {
                        values: {
                          course:api.pageParam.course,
                          module: tmodule,
                          start: String(tstart),
                          end: endA,
                          color: tcolor
                    },
                  },

                },function(ret, err){
                    if (ret) {

                    } else {
                        //alert( JSON.stringify( err ) );
                    }
                });

              } else {
                  api.alert({
                    title:'Invalid Action',
                    msg:'Timetable block already exists'
                  })
              }
          });

        }else{ // if start is before end
          api.alert({
            title:'Invalid Action',
            msg:'Start time cannot be after end time'
          })

        }

      })





    };

</script>

</html>
