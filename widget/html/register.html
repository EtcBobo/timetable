<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <title>Register Page</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />


</head>

<body>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

 <div class="container">
   <br>

   <div id="signup">Register Here!</div>
    <br>
<div class="row" id="divError" style="display:none;">
<div class="col-md-12">
  <p id="errorMsg" style="color:red;text-align:center"></p>
</div>
</div>

    <div class="row">

        <div class="col-md-12">

        <img id="output" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" class="img-responsive" width="100" height="100">

        </div>
      </div>
        <br>
        <br>
        <div class="row">

                <div class="col-md-12">
        <button onclick="uploadImage()" class="btn btn-primary btn-lg upload-group text-center" id="upButton">Upload</button>
        </div>

        <br>
        <br>
        <br>
        </div>


    <form method="post" id="registerForm" class="form-group col-lg-12" enctype="multipart/form-data">
         <div class="form-group col-md-12" id="regbox">

                <div class="row">
                <div class="form-group col-md-12">
                    Username:<br>
                <input type="text" name="username" id="username" class="form-control" required>
                </div>
                </div>
                <div class="row">
                <div class="form-group col-md-12">
                    Password:<br>
                    <input type="password" name="password" class="form-control" id="password" minlength=6 required>
                    <!--
                <input type="password" name="password" class="form-control" minlength=6>
              -->
                </div>
                </div>

                <div class="row">
                <div class="form-group col-md-12">
                    Confirm Password:<br>
                    <input type="password" name="passwordc" class="form-control" minlength=6 required>
                    <!--
                <input type="password" name="confirm_password" class="form-control" minlength=6>
                -->
                </div>
                </div>
                <div class="row">
                <div class="form-group col-md-12">
                    Email:<br>
                <input type="email" name="email" id="email" class="form-control" required>
                </div>
                </div>
                <div class="form-row">
                <div class="form-group col-sm-3" style="width:60%">
                    <label>Phone Number:</label>
                <input type="number" name="phoneNo" id="phoneNo" class="form-control" required>


                </div>
                <div class="form-group col-sm-3" style="width:40%">
                  <br>
                  <span class="btn btn-primary btn-lg upload-group text-center" id="codeButton">Send Code</span>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col-sm-12" >
                  <label>Verification Code:</label>
              <input type="number" name="code" id="code" class="form-control" required>
                </div>
              </div>

              <!--
              <div class="form-row">
                <div class="form-group col-sm-12" >
                  <label>Verification Code:</label>
            <span class="btn btn-primary btn-lg upload-group text-center" id="verifyButton">verify</span>
                </div>
              </div>

            -->

                <div class="row">
                        <div class="form-group col-md-12">
                            School:<br>
                            <select class="form-control" name="pref" id="school">
                                    <option value="School 1">School 1</option>
                                    <option value="School 2">School 2</option>
                                    <option value="School 3">School 3</option>
                                    <option value="School 4">School 4</option>
                                    <option value="School 5">School 5</option>
                                  </select>
                        </div>
                  </div>
                  <div class="row">
                          <div class="form-group col-md-12">
                              Course:<br>
                              <select class="form-control" name="pref" id="course">
                                <option value="Course 1">Course 1</option>
                                <option value="Course 2">Course 2</option>
                                <option value="Course 3">Course 3</option>
                                <option value="Course 4">Course 4</option>
                                <option value="Course 5">Course 5</option>
                              </select>
                          </div>
                  </div>

                <div class="row">
                    <div class="col-md-12">
                        <input type="checkbox" name="terms" required>I agree to the <a href="/rules">terms of services</a>
                    </div>
                </div>
                <br>


                <div class="row">
                <div class="form-group col-md-12">
                        <button type="submit" class="btn btn-primary btn-lg upload-group text-center" id="uploadButton">Register</button>
                    </div>
                    <br>
                </div>
                </div>

               </form>

</div>



<script type="text/javascript">

var theIp = ''
$(function (){
  var myAjax = {
    init: function(){
      $.ajax({
        url: "../wifi.txt",
        async:true,
        success:function(data){
          theIp = data
        }
      })
    }
  };
  myAjax.init()
});

function loadCourse(){
  if(document.getElementById("course 1").selected){


  }
}

function uploadImage(){
  api.getPicture({
      sourceType: 'library',
      encodingType: 'jpg',
      mediaValue: 'pic',
      destinationType: 'base64',
      allowEdit: true,
      saveToPhotoAlbum: false
  }, function(ret, err) {
      if (ret) {
          $('#output').attr('src',ret.base64Data);

      } else {
          alert(JSON.stringify(err));
      }
  });
}


apiready = function() {
  var moduleSMSSDK = api.require('smssdk');
$("#codeButton").click(function(){

    var tphoneNum = $("#phoneNo").val();
    console.log(tphoneNum)
    moduleSMSSDK.getTextCode({
      phoneNumber:tphoneNum,
      zone:'86'
    },function(ret,err){
      if (err !== null && err !== undefined && err !== '') {
      alert("Error:\n" + JSON.stringify(err));
    } else {
       alert("Success:\n" + JSON.stringify(ret));
    }
  });
  })

$("#verifyButton").click(function(){
var tphoneNum = $("#phoneNo").val();
var tverify = $("#code").val();
moduleSMSSDK.commitCode({
  zone:'86',
  phoneNumber:tphoneNum,
  code:tverify
},function(ret, err){
  if (err !== null && err !== undefined && err !== '') {
    // 错误消息示例：{"msg":"Template not exist.","code":484}
    alert("Error:\n" + JSON.stringify(err));
    } else {
      console.log("correct code")
    }
})
})

   $("#registerForm").submit(function(event) {

    //  api.openFrame({
    //    name: "Loading Page",
    //    url: 'loadingScreen.html',
    //    bounces: true,
    //    rect: {
    //        marginTop: 71,
    //        marginBottom: 71,
    //        w: 'auto'
    //    }
    // })

      event.preventDefault();
      var $form = $(this),
      tusername = $form.find('input[name="username"]').val(),
      temail = $form.find('input[name="email"]').val(),
      tpassword = $form.find('input[name="password"]').val(),
      tpasswordc = $form.find('input[name="passwordc"]').val(),
      tcode = $form.find('input[name="code"]').val(),
      tphone = $form.find('input[name="phoneNo"]').val();
      var tschool = $('#school').find(":selected").text()
      var tcourse = $('#course').find(":selected").text()
      var letterNumber = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/;
      if(letterNumber.test(tpassword) && tpassword == tpasswordc){
        moduleSMSSDK.commitCode({
          zone:'86',
          phoneNumber:tphone,
          code:tcode
        },function(ret, err){
          if (err !== null && err !== undefined && err !== '') {
            document.getElementById("errorMsg").innerHTML = "Incorrect verification code"
            document.getElementById("divError").style.display = "block"
            window.scrollTo(0,0)
            alert("Error:\n" + JSON.stringify(err));
            } else {
              api.ajax({
                  url: theIp + 'register',
                  method: 'post',
                  timeout:30,
                  data: {
                      values: {
                          username: tusername,
                          email: temail,
                          password: tpassword,
                          phoneNo: tphone,
                          school:tschool,
                          course:tcourse,
                          imgPath: document.getElementById("output").src
                      },
                  },
                },
                 function(ret, err){

                    console.log(ret)
                    if(ret.registerStatus=="true"){
                      api.alert({ msg: "You have successfully Registered" });
                      api.openWin({
                        name: "Login Page",
                        url: '../index.html'

                                })
                      }
                      else if(ret.errorRea == "username"){
                        document.getElementById("errorMsg").innerHTML = "Username taken, please choose another username"
                        document.getElementById("divError").style.display = "block"
                        window.scrollTo(0,0)
                      }
                      else if(ret.errorRea == "email"){
                        document.getElementById("errorMsg").innerHTML = "Email has already been used, please enter another email"
                        document.getElementById("divError").style.display = "block"
                        window.scrollTo(0,0)
                      }
                      else if(ret.errorRea == "phone"){
                        document.getElementById("errorMsg").innerHTML = "Phone number has already been used, please enter another number"
                        document.getElementById("divError").style.display = "block"
                        window.scrollTo(0,0)
                      }
                    })
            }
            });
      }
      else if(tpassword != tpasswordc){
        document.getElementById("errorMsg").innerHTML = "Password does not match. Please ensure you enter the same password in the confirm password field"
        document.getElementById("divError").style.display = "block"
        window.scrollTo(0,0)
      }
      else if(letterNumber.test(tpassword) != true){
        document.getElementById("errorMsg").innerHTML = "Please ensure that password have at least an Alphabet and a number"
        document.getElementById("divError").style.display = "block"
        window.scrollTo(0,0)
      }
      else{
        document.getElementById("errorMsg").innerHTML = "Unknown error"
        document.getElementById("divError").style.display = "block"
        window.scrollTo(0,0)
      }

})

}

</script>


<style>


      #file{
text-align: center;
margin-left: 50px;
}

#codeButton{
  background-color: green;
  color: #fff!important;
  font-size: 14px;
  height: 42px;
  margin-top:5px;
  }


  #uploadButton{
    background-color: #007bff;
    color: #fff!important;
    font-size: 14px;
    height: 42px;
    }


    #email {
        font-size:12px;
        font-weight: bold;
        color: black;

    }


#signup{
    display: block;
    font-size: 150%;
    font-family: 'Montserrat', sans-serif;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: .1em;
    text-align:center;
}






@media(max-width: 900px){
    #regbox{
    width:100%;
    margin-left:0px;
}
#output{
  margin-left:115px;
}
}

#image{
  text-align: center;
  margin-left: 50px;
}

#upButton{
  margin-left: 125px;
  background-color: rgb(126, 134, 13);
  color: #fff!important;
  font-size: 14px;
  height: 42px;
}


</style>
</body>
</html>
